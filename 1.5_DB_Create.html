<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Regeneration_2_16Sept24 - 1.5 DB Create</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Regeneration_2_16Sept24</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./1.0_Import_Clean.html"> 
<span class="menu-text">1 Import Clean</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./1.5_DB_Create.html" aria-current="page"> 
<span class="menu-text">1.5 DB Create</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./2_FVS_Variables.html"> 
<span class="menu-text">2 FVS Vars</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./3_RandomForests_Prep.html"> 
<span class="menu-text">3 RF Prep</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./4_RF_by_Eco.html"> 
<span class="menu-text">4 RF Ecos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./5_TD_Imp.html"> 
<span class="menu-text">5 TD Imp</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./6_distributions.html"> 
<span class="menu-text">6 Histos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./7_RF_GroupSpp_and_Counts.html"> 
<span class="menu-text">7 RF Groups &amp; Counts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./8_RF_Spp_Groups.html"> 
<span class="menu-text">8 RF Spp Groups</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./9_RF_Regression.html"> 
<span class="menu-text">9 RF Reg</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./10_Hyperparameters.html"> 
<span class="menu-text">10 Hyper Params</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./11_Heatmap.html"> 
<span class="menu-text">11- 1st Map</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./12_Error_Map.html"> 
<span class="menu-text">12 Error Map</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#re-write" id="toc-re-write" class="nav-link active" data-scroll-target="#re-write">Re-Write</a>
  <ul class="collapse">
  <li><a href="#pseudo-code" id="toc-pseudo-code" class="nav-link" data-scroll-target="#pseudo-code">Pseudo code</a></li>
  <li><a href="#parts-1-3" id="toc-parts-1-3" class="nav-link" data-scroll-target="#parts-1-3">Parts 1-3</a></li>
  <li><a href="#part-4-1" id="toc-part-4-1" class="nav-link" data-scroll-target="#part-4-1">Part 4</a></li>
  <li><a href="#part-5" id="toc-part-5" class="nav-link" data-scroll-target="#part-5">Part 5</a></li>
  </ul></li>
  <li><a href="#difference-in-nrows" id="toc-difference-in-nrows" class="nav-link" data-scroll-target="#difference-in-nrows">Difference in nrows</a></li>
  <li><a href="#difference-in-.out-file" id="toc-difference-in-.out-file" class="nav-link" data-scroll-target="#difference-in-.out-file">Difference in .out file</a></li>
  <li><a href="#end" id="toc-end" class="nav-link" data-scroll-target="#end">End</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">1.5 DB Create</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><em>Rachelâ€™s Original Code</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sqldf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Set working directory as the master folder with all FIA SQLite databases within their </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="do">## individual folders. Named: FIADBs.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">Houtmanr</span><span class="sc">\\</span><span class="st">FVS_Tradeoffs</span><span class="sc">\\</span><span class="st">rFVSProcessing</span><span class="sc">\\</span><span class="st">FIADBs"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This file lists all unique stand identifiers (Plot_CN) values for the study area</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="do">### ENTER CORRECT STAND TABLE PATHWAY HERE </span><span class="al">###</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"C:/Users/houtmanr/FVS_Tradeoffs/rFVSProcessing/FIADBs/Stands_byVariantR1_Carbon_2014.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">unique</span>(target_stands[<span class="st">"CN"</span>]))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span><span class="fu">setkey</span>(target_stands, CN)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>fuel_stands <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">read.table</span>(<span class="st">"C:/Users/houtmanr/FVS_Tradeoffs/rFVSProcessing/FVSInputFiles/DWM_table_with_mangrove_v5.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">header =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered <span class="ot">&lt;-</span> fuel_stands[fuel_stands<span class="sc">$</span>ObsCN <span class="sc">%in%</span> target_stands<span class="sc">$</span>CN,]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">list.dirs</span>()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"SQLit"</span>, states, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>tree_header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"STAND_CN"</span>, <span class="st">"INVYR"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"Tree_count"</span>, <span class="st">"SPCD"</span>, <span class="st">"DBH"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>, <span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through every state database and extracts the tree data from FIA</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>tree_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(db <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states)){</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># connect to the sqlite file</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  dbtitle <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> states[db], <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  dbname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(states[db], <span class="st">"</span><span class="sc">\\</span><span class="st">"</span>, dbtitle)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">=</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname=</span>dbname)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a list of all tables</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  alltables <span class="ot">=</span> <span class="fu">dbListTables</span>(con)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  alltables</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  tree <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select PLT_CN, INVYR, STATUSCD, TPA_UNADJ, SPCD, DIA, HT, ACTUALHT, CR, SUBP, TREE, AGENTCD from TREE'</span>))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  target_stands<span class="sc">$</span>CN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(target_stands<span class="sc">$</span>CN)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  tree_filtered <span class="ot">&lt;-</span> <span class="fu">merge</span>(tree, target_stands, <span class="at">by.x =</span> <span class="st">"PLT_CN"</span>, <span class="at">by.y =</span> <span class="st">"CN"</span>) </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  tree_filtered[, <span class="st">':='</span> (<span class="at">Species =</span> (SPCD), <span class="at">History =</span> <span class="dv">1</span>, <span class="at">CrRatio =</span> CR )]</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  tree_filtered[AGENTCD <span class="sc">!=</span> <span class="st">'NULL'</span>, <span class="st">':='</span> (<span class="at">History =</span> <span class="dv">8</span>)]</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  tree_characteristics <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"PLT_CN"</span>, <span class="st">"INVYR"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"TPA_UNADJ"</span>, <span class="st">"SPCD"</span>, <span class="st">"DIA"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>, <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>,<span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  tree_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree_table, tree_filtered[, tree_characteristics, <span class="at">with=</span><span class="cn">FALSE</span>])</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The trees in "</span>, states[db], <span class="st">" have been found."</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>forest_type <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * FROM REF_FOREST_TYPE'</span>))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_table) <span class="ot">&lt;-</span> tree_header</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tree_table<span class="sc">$</span>STAND_CN))</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through the stand characteristics and builds an input stand table for FVS</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>stand_header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"STAND_CN"</span>, <span class="st">"INV_YEAR"</span>, <span class="st">"CASE"</span>, <span class="st">"BASAL_AREA_FACTOR"</span>, <span class="st">"INV_PLOT_SIZE"</span>, <span class="st">"BRK_DBH"</span>)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>stand_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>fine_fuels_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(db <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states)){</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># connect to the sqlite file</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  dbtitle <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> states[db], <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  dbname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(states[db], <span class="st">"</span><span class="sc">\\</span><span class="st">"</span>, dbtitle)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">=</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname=</span>dbname[<span class="dv">1</span>])</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a list of all tables</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  alltables <span class="ot">=</span> <span class="fu">dbListTables</span>(con)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  plot_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select CN, INVYR from PLOT'</span>))</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> plot_table[CN <span class="sc">%in%</span> target_stands<span class="sc">$</span>CN,]</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> <span class="fu">setkey</span>(plot_filtered, CN)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(plot_filtered[, <span class="st">':='</span> (<span class="at">INV_YEAR =</span> <span class="dv">2014</span>, <span class="at">CASE =</span> (INVYR), <span class="at">INVYR =</span> <span class="cn">NULL</span>, <span class="at">BASAL_AREA_FACTOR =</span> <span class="dv">0</span>, <span class="at">INV_PLOT_SIZE =</span> <span class="dv">1</span>, <span class="at">BRK_DBH =</span> <span class="dv">999</span>)])</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  stand_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(stand_table, plot_filtered)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  stand_table <span class="ot">&lt;-</span><span class="fu">setkey</span>(stand_table,CN)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fuels</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  fwd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select PLT_CN, INVYR, FWD_SM_CARBON_COND, FWD_SM_DRYBIO_COND,FWD_MD_CARBON_COND, FWD_MD_DRYBIO_COND, FWD_LG_CARBON_COND, FWD_LG_DRYBIO_COND, LITTER_CARBON, LITTER_BIOMASS, DUFF_CARBON, DUFF_BIOMASS from COND_DWM_CALC'</span>))</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  fwd_table_complete <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * from COND_DWM_CALC'</span>))</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  fwd_filtered <span class="ot">&lt;-</span> <span class="fu">unique</span>(fwd_table[PLT_CN <span class="sc">%in%</span> fuel_stands_filtered<span class="sc">$</span>PredCN,])</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add Fuels data</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_0_25_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_SM_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_25_1_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_MD_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_1_3_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_LG_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  fine_fuels_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fine_fuels_table, fwd_filtered)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  cwd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select PLT_CN, DRYBIO_AC_COND, DECAYCD, TRANSDIA from DWM_COARSE_WOODY_DEBRIS'</span>))</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  cwd_table <span class="ot">&lt;-</span><span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * from DWM_COARSE_WOODY_DEBRIS'</span>))</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  cwd_fuels <span class="ot">&lt;-</span> cwd_table[PLT_CN <span class="sc">%in%</span> fuel_stands_filtered<span class="sc">$</span>PredCN,]</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  groupcwd <span class="ot">&lt;-</span> <span class="fu">group_by</span>(cwd_fuels, PLT_CN)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  coarsefuels <span class="ot">=</span> <span class="fu">as.data.table</span>(<span class="fu">summarize</span>(groupcwd, </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_3_6_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">6</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_6_12_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">6</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">12</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_12_20_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">20</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_20_35_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">20</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">35</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_35_50_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">35</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_gt_50_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_3_6_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">6</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_6_12_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">6</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">12</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_12_20_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">20</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_20_35_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">20</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">35</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_35_50_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">35</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Fuel_gt_50_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>))</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  coarse_fuels_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(coarse_fuels_table, coarsefuels)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The stands in "</span>, states[db], <span class="st">" have been found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="do">## Original stand data from Fuel Map.</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>PredCN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(fuel_stands_filtered<span class="sc">$</span>PredCN)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>ObsCN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(fuel_stands_filtered<span class="sc">$</span>ObsCN)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">merge</span>(fuel_stands_filtered[,<span class="fu">c</span>(<span class="st">"PredCN"</span>, <span class="st">"ObsCN"</span>)], coarse_fuels_table,  <span class="at">by.x =</span> <span class="st">"PredCN"</span>, <span class="at">by.y =</span> <span class="st">"PLT_CN"</span>)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>fine_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">merge</span>(fuel_stands_filtered[,<span class="fu">c</span>(<span class="st">"PredCN"</span>, <span class="st">"ObsCN"</span>)], fine_fuels_table,  <span class="at">by.y =</span> <span class="st">"PLT_CN"</span>, <span class="at">by.x =</span> <span class="st">"PredCN"</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stand_table) <span class="ot">&lt;-</span> stand_header</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="do">## Add fuel variables to the stand data</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_0_25_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_SM_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_25_1_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_MD_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_1_3_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_LG_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_Litter <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>LITTER_CARBON<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_Duff <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>DUFF_CARBON<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fuel_stands_filtered)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered <span class="ot">&lt;-</span> <span class="fu">setkey</span>(fuel_stands_filtered, STAND_CN)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>stand_table <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stand_table, STAND_CN)</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Add fine fuels.</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span><span class="fu">merge</span>(stand_table, fuel_stands_filtered[,<span class="fu">c</span>(<span class="st">"STAND_CN"</span>,<span class="st">"Fuel_0_25_H"</span>,<span class="st">"Fuel_25_1_H"</span>,<span class="st">"Fuel_1_3_H"</span>,<span class="st">"Fuel_Litter"</span>,<span class="st">"Fuel_Duff"</span>)])</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stands_with_finefuels, STAND_CN)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coarse_fuels_table_stands)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">setkey</span>(coarse_fuels_table_stands, STAND_CN)</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>stands_with_fuels <span class="ot">&lt;-</span> <span class="fu">left_join</span>(stands_with_finefuels, coarse_fuels_table_stands)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>stands_with_fuels<span class="sc">$</span>PredCN <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NA values when writing files (FVS does NOT like them)</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a><span class="do">### UPDATE YOUR OUTPUT FILE NAMES HERE </span><span class="al">###</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(tree_table, <span class="at">file =</span> <span class="st">"tree_table_R1_Carbon_2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(stands_with_fuels, <span class="at">file =</span> <span class="st">"stand_table_R1_Carbon2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><em>Libraries</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())                                                      </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()                                                                                 </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Data tidying and acces</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse, <span class="at">quietly =</span> T)       <span class="co"># Easy to read syntax and data manipulation                   </span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RSQLite)                      <span class="co"># Access SQLite dbs   </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)                     <span class="co"># Pipes and math functions    </span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># library(readxl)                     # Read xlsx </span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># library(writexl)                    # write xlsx     </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                                                   </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># yaImpute and related                           </span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># library(yaImpute)                     # RF imputation     </span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># library(vegan)                        # Something to do the yaImpute </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># library(randomForest)                 # RF package that yaImpute uses                                   </span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                                                     </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># plots and tables                          </span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># library(esquisse)                     # Quick data visualization   </span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># library(knitr)                        # Better html tables</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># library(DT)                           # Data tables for Java script tables in HTML</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                                                      </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># library(kableExtra)                   # Better html tables, change sizes        </span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># library(feather)                      # Faster data retrieval    </span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Geography</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># library(sf)                           # Simple Features/vector data</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># library(terra)                        # Raster functions</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># library(spatstat)                     # Spatial stats</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Rachel's libraries</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># library(RSQLite)       # Already loaded                    </span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sqldf)                                        </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># library(DBI)                                        </span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)                                        </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                                 </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># No sci-notation. </span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><em>Functions</em></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>clean_mem <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">ls</span>(<span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls()[!(ls() %in% keep)]</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(<span class="at">list =</span> x[<span class="sc">!</span>(x <span class="sc">%in%</span> keep)], <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"keep"</span>, <span class="st">"clean_mem"</span>, <span class="st">"clean_na_cols"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>clean_na_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df[, <span class="fu">colSums</span>(<span class="fu">is.na</span>(df)) <span class="sc">&lt;</span> <span class="fu">nrow</span>(df)]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(df)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>db_list <span class="ot">&lt;-</span> <span class="cf">function</span>(df, CN_col){</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">select</span>({{CN_col}})</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> name <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">CN_col =</span> <span class="fu">str_c</span>(<span class="st">"'"</span>, {{CN_col}}, <span class="st">"'"</span>)) </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> <span class="fu">str_flatten_comma</span>(name<span class="sc">$</span>CN_col)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># name &lt;- str_flatten_comma(name[, CN_col])</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  name</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Breaking down Rachelâ€™s code</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Pseudo code</p>
<ol type="1">
<li>setup</li>
</ol>
<ul>
<li>scientific notation off</li>
<li>set wd to folder with FIADB.</li>
<li>read in standlist (?TM)</li>
<li>ensure there are no repeat plt_cns</li>
<li>add a key for quicker sorting and filtering</li>
<li>read in fuelmap DWM table (?FM)</li>
<li>find FMâ€™s Observed PLT_CNs in standlist (TMâ€™s) CNs</li>
<li>list files DBs in folder</li>
<li>filter for sqlite db names</li>
</ul>
<ol start="2" type="1">
<li>Tree table</li>
</ol>
<ul>
<li>Create header for tree table.</li>
<li>Ensure blank tree table to write to</li>
<li>For each database in the list of state dbs
<ul>
<li>connect to the state db</li>
<li>get the list of tables</li>
<li>set tree to those columns needed for FVS from FIA TREE table</li>
<li>join standlist and TREE table</li>
<li>Change FIA.TREE.SPCD to Species, Set History to 1, and Change CR to CrRatio</li>
<li>Where AgentCD is not null set History to 8</li>
<li>list the columns to select</li>
<li>select the columns</li>
<li>concatenate and print the stats in db have been found</li>
<li>Disconnect and start the loop over.</li>
</ul></li>
<li>Find forest type reference in a db, this is confusing, there is no connection</li>
<li>set the tree table names</li>
<li>find all plots with trees in the tree list.</li>
</ul>
<ol start="3" type="1">
<li>Plots table</li>
</ol>
<ul>
<li>set the stand header</li>
<li>ensure a blank canvas with NULL stand &amp; fuels tables</li>
<li>For each db in the list of DBs
<ol type="a">
<li>connect</li>
</ol>
<ul>
<li>find the db path and connect to it</li>
<li>list the tables</li>
</ul>
<ol start="2" type="a">
<li>set tables</li>
</ol>
<ul>
<li>select CN and invyr from plot</li>
<li>find all standlist in plot table by CN</li>
<li>set a key for sorting and filtering quickly</li>
</ul>
<ol start="3" type="a">
<li>alter tables</li>
</ol>
<ul>
<li>Set := INV_YEAR = 2014: Adds a new column INV_YEAR with all entries set to 2014.</li>
<li>CASE = (INVYR): Adds a new column CASE and sets its values to be the same as those in the existing column INVYR.</li>
<li>INVYR = NULL: Removes the INVYR column from the data.table.</li>
<li>BASAL_AREA_FACTOR = 0: Adds a new column BASAL_AREA_FACTOR with all entries set to 0.</li>
<li>INV_PLOT_SIZE = 1: Adds a new column INV_PLOT_SIZE with all entries set to 1.</li>
<li>BRK_DBH = 999: Adds a new column BRK_DBH with all entries set to 999.</li>
</ul>
<ol start="4" type="a">
<li>make the stand table</li>
</ol>
<ul>
<li>add the stand info from each db to the stand table</li>
</ul>
<ol start="5" type="a">
<li>Fine Fuels</li>
</ol>
<ul>
<li>fine woody debris is list of columns from COND_DWM_CALC</li>
<li>Complete is * from COND_DWM_CALC</li>
<li>find the FM pred CNs in the db</li>
<li>Set the FVS variables from the FIA variables and correct Tons to lbs</li>
<li>Add our CNâ€™s fwd to the the fine fuels table</li>
</ul>
<ol start="6" type="a">
<li>Course Fuels</li>
</ol>
<ul>
<li>get columns from DWM_Coarse Woody degris</li>
<li>get * from DWM_Coarse Woody degris</li>
<li>filter db for our Pred cns</li>
</ul>
<ol start="7" type="a">
<li>fix CWD table</li>
</ol>
<ul>
<li>group CWD by PLT_CN</li>
<li>set each FVS fuel group to the sum of fuels with diameters at correct size and correct for tons to lbs.</li>
<li>add this states data to the new table</li>
<li>concatenate and print complete</li>
<li>disconnect and start the next state</li>
</ul></li>
</ul>
<ol start="4" type="1">
<li>New db</li>
</ol>
<ul>
<li>correct CNs to chr</li>
<li>add coarse fuel data from FM to TM</li>
<li>add fine fuel data from FM to TM</li>
<li>set column names</li>
<li>add fuel to the new stand table
<ul>
<li>I am not sure why FWD and stuff are being multiplied by 2</li>
</ul></li>
<li>Set CN to STAND_CN for FVS</li>
<li>Set X and X.1 to Null</li>
<li>Set a key to sort and filter</li>
<li>add fine fuels to new stand table</li>
<li>join the fine and coarse fuel tables</li>
<li>Remove PredCN and NA values</li>
<li>write new db.</li>
</ul>
<section id="part-1" class="level2">
<h2 class="anchored" data-anchor-id="part-1">Part 1</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Set working directory as the master folder with all FIA SQLite databases within their </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## individual folders. Named: FIADBs.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">Houtmanr</span><span class="sc">\\</span><span class="st">FVS_Tradeoffs</span><span class="sc">\\</span><span class="st">rFVSProcessing</span><span class="sc">\\</span><span class="st">FIADBs"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This file lists all unique stand identifiers (Plot_CN) values for the study area</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="do">### ENTER CORRECT STAND TABLE PATHWAY HERE </span><span class="al">###</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">read.table</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"C:/Users/houtmanr/FVS_Tradeoffs/rFVSProcessing/FIADBs/Stands_byVariantR1_Carbon_2014.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">unique</span>(target_stands[<span class="st">"CN"</span>]))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">setkey</span>(target_stands, CN)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>fuel_stands <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.table</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C:/Users/houtmanr/FVS_Tradeoffs/rFVSProcessing/FVSInputFiles/DWM_table_with_mangrove_v5.csv"</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">header =</span> <span class="cn">TRUE</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered <span class="ot">&lt;-</span> fuel_stands[fuel_stands<span class="sc">$</span>ObsCN <span class="sc">%in%</span> target_stands<span class="sc">$</span>CN,]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">list.dirs</span>()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"SQLit"</span>, states, <span class="at">value =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-2" class="level2">
<h2 class="anchored" data-anchor-id="part-2">Part 2</h2>
<ol start="2" type="1">
<li>Tree table</li>
</ol>
<ul>
<li>Create header for tree table.</li>
<li>Ensure blank tree table to write to</li>
<li>For each database in the list of state dbs
<ul>
<li>connect to the state db</li>
<li>get the list of tables</li>
<li>set tree to those columns needed for FVS from FIA TREE table</li>
<li>join standlist and TREE table</li>
<li>Change FIA.TREE.SPCD to Species, Set History to 1, and Change CR to CrRatio</li>
<li>Where AgentCD is not null set History to 8</li>
<li>list the columns to select</li>
<li>select the columns</li>
<li>concatenate and print the stats in db have been found</li>
<li>Disconnect and start the loop over.</li>
</ul></li>
<li>Find forest type reference in a db, this is confusing, there is no connection</li>
<li>set the tree table names</li>
<li>find all plots with trees in the tree list.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tree_header <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"STAND_CN"</span>, <span class="st">"INVYR"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"Tree_count"</span>, <span class="st">"SPCD"</span>, <span class="st">"DBH"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>, <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through every state database and extracts the tree data from FIA</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>tree_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(db <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states)){</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># connect to the sqlite file</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  dbtitle <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> states[db], <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  dbname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(states[db], <span class="st">"</span><span class="sc">\\</span><span class="st">"</span>, dbtitle)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">=</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname=</span>dbname)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a list of all tables</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  alltables <span class="ot">=</span> <span class="fu">dbListTables</span>(con)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  alltables</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  tree <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbGetQuery</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      con, <span class="st">'select PLT_CN, INVYR, STATUSCD, TPA_UNADJ, SPCD, DIA, HT, ACTUALHT, CR, SUBP, TREE, AGENTCD from TREE'</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  target_stands<span class="sc">$</span>CN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(target_stands<span class="sc">$</span>CN)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  tree_filtered <span class="ot">&lt;-</span> <span class="fu">merge</span>(tree, target_stands, <span class="at">by.x =</span> <span class="st">"PLT_CN"</span>, <span class="at">by.y =</span> <span class="st">"CN"</span>) </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  tree_filtered[, <span class="st">':='</span> (<span class="at">Species =</span> (SPCD), <span class="at">History =</span> <span class="dv">1</span>, <span class="at">CrRatio =</span> CR )]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  tree_filtered[AGENTCD <span class="sc">!=</span> <span class="st">'NULL'</span>, <span class="st">':='</span> (<span class="at">History =</span> <span class="dv">8</span>)]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  tree_characteristics <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PLT_CN"</span>, <span class="st">"INVYR"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"TPA_UNADJ"</span>, <span class="st">"SPCD"</span>, <span class="st">"DIA"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>, <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>, </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  tree_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree_table, tree_filtered[, tree_characteristics, <span class="at">with=</span><span class="cn">FALSE</span>])</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The trees in "</span>, states[db], <span class="st">" have been found."</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>forest_type <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * FROM REF_FOREST_TYPE'</span>))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree_table) <span class="ot">&lt;-</span> tree_header</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tree_table<span class="sc">$</span>STAND_CN))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-3" class="level2">
<h2 class="anchored" data-anchor-id="part-3">Part 3</h2>
<ol start="3" type="1">
<li>Plots table</li>
</ol>
<ul>
<li>set the stand header</li>
<li>ensure a blank canvas with NULL stand &amp; fuels tables</li>
<li>For each db in the list of DBs
<ol type="a">
<li>connect</li>
</ol>
<ul>
<li>find the db path and connect to it</li>
<li>list the tables</li>
</ul>
<ol start="2" type="a">
<li>set tables</li>
</ol>
<ul>
<li>select CN and invyr from plot</li>
<li>find all standlist in plot table by CN</li>
<li>set a key for sorting and filtering quickly</li>
</ul>
<ol start="3" type="a">
<li>alter tables</li>
</ol>
<ul>
<li>Set := INV_YEAR = 2014: Adds a new column INV_YEAR with all entries set to 2014.</li>
<li>CASE = (INVYR): Adds a new column CASE and sets its values to be the same as those in the existing column INVYR.</li>
<li>INVYR = NULL: Removes the INVYR column from the data.table.</li>
<li>BASAL_AREA_FACTOR = 0: Adds a new column BASAL_AREA_FACTOR with all entries set to 0.</li>
<li>INV_PLOT_SIZE = 1: Adds a new column INV_PLOT_SIZE with all entries set to 1.</li>
<li>BRK_DBH = 999: Adds a new column BRK_DBH with all entries set to 999.</li>
</ul>
<ol start="4" type="a">
<li>make the stand table</li>
</ol>
<ul>
<li>add the stand info from each db to the stand table</li>
</ul>
<ol start="5" type="a">
<li>Fine Fuels</li>
</ol>
<ul>
<li>fine woody debris is list of columns from COND_DWM_CALC</li>
<li>Complete is * from COND_DWM_CALC</li>
<li>find the FM pred CNs in the db</li>
<li>Set the FVS variables from the FIA variables and correct Tons to lbs</li>
<li>Add our CNâ€™s fwd to the the fine fuels table</li>
</ul>
<ol start="6" type="a">
<li>Course Fuels</li>
</ol>
<ul>
<li>get columns from DWM_Coarse Woody degris</li>
<li>get * from DWM_Coarse Woody degris</li>
<li>filter db for our Pred cns</li>
</ul>
<ol start="7" type="a">
<li>fix CWD table</li>
</ol>
<ul>
<li>group CWD by PLT_CN</li>
<li>set each FVS fuel group to the sum of fuels with diameters at correct size and correct for tons to lbs.</li>
<li>add this states data to the new table</li>
<li>concatenate and print complete</li>
<li>disconnect and start the next state</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through the stand characteristics and builds an input stand table for FVS</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>stand_header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"STAND_CN"</span>, <span class="st">"INV_YEAR"</span>, <span class="st">"CASE"</span>, <span class="st">"BASAL_AREA_FACTOR"</span>, <span class="st">"INV_PLOT_SIZE"</span>, <span class="st">"BRK_DBH"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>stand_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>fine_fuels_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(db <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states)){</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># connect to the sqlite file</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  dbtitle <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> states[db], <span class="at">full.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  dbname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(states[db], <span class="st">"</span><span class="sc">\\</span><span class="st">"</span>, dbtitle)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">=</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname=</span>dbname[<span class="dv">1</span>])</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a list of all tables</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  alltables <span class="ot">=</span> <span class="fu">dbListTables</span>(con)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  plot_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select CN, INVYR from PLOT'</span>))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> plot_table[CN <span class="sc">%in%</span> target_stands<span class="sc">$</span>CN,]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> <span class="fu">setkey</span>(plot_filtered, CN)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  plot_filtered <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    plot_filtered[</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      , <span class="st">':='</span> (</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">INV_YEAR =</span> <span class="dv">2014</span>, <span class="at">CASE =</span> (INVYR), <span class="at">INVYR =</span> <span class="cn">NULL</span>, <span class="at">BASAL_AREA_FACTOR =</span> <span class="dv">0</span>, <span class="at">INV_PLOT_SIZE =</span> <span class="dv">1</span>, <span class="at">BRK_DBH =</span> <span class="dv">999</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  stand_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(stand_table, plot_filtered)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  stand_table <span class="ot">&lt;-</span><span class="fu">setkey</span>(stand_table,CN)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fuels</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  fwd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbGetQuery</span>(con, <span class="fu">paste0</span>(</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>               <span class="st">'select '</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>               <span class="st">'PLT_CN, INVYR, FWD_SM_CARBON_COND, FWD_SM_DRYBIO_COND,FWD_MD_CARBON_COND, FWD_MD_DRYBIO_COND,'</span>, </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>               <span class="st">'FWD_LG_CARBON_COND, FWD_LG_DRYBIO_COND, LITTER_CARBON, LITTER_BIOMASS, DUFF_CARBON, DUFF_BIOMASS '</span>, </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>               <span class="st">'from COND_DWM_CALC'</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>               ))</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  fwd_table_complete <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * from COND_DWM_CALC'</span>))</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  fwd_filtered <span class="ot">&lt;-</span> <span class="fu">unique</span>(fwd_table[PLT_CN <span class="sc">%in%</span> fuel_stands_filtered<span class="sc">$</span>PredCN,])</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add Fuels data</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_0_25_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_SM_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_25_1_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_MD_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  fwd_table<span class="sc">$</span>Fuel_1_3_H <span class="ot">&lt;-</span> fwd_table<span class="sc">$</span>FWD_LG_DRYBIO_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  fine_fuels_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fine_fuels_table, fwd_filtered)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  cwd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select PLT_CN, DRYBIO_AC_COND, DECAYCD, TRANSDIA from DWM_COARSE_WOODY_DEBRIS'</span>))</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  cwd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * from DWM_COARSE_WOODY_DEBRIS'</span>))</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  cwd_fuels <span class="ot">&lt;-</span> cwd_table[PLT_CN <span class="sc">%in%</span> fuel_stands_filtered<span class="sc">$</span>PredCN,]</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  groupcwd <span class="ot">&lt;-</span> <span class="fu">group_by</span>(cwd_fuels, PLT_CN)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  coarsefuels <span class="ot">=</span> <span class="fu">as.data.table</span>(</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(groupcwd, </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_3_6_H =</span>   <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">3</span>  <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">6</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_6_12_H =</span>  <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">6</span>  <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">12</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_12_20_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">20</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_20_35_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">20</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">35</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_35_50_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">35</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_gt_50_H =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>, </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_3_6_S =</span>   <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">3</span>  <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">6</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_6_12_S =</span>  <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">6</span>  <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">12</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_12_20_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">20</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_20_35_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">20</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">35</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_35_50_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">35</span> <span class="sc">&amp;</span> TRANSDIA <span class="sc">&lt;</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span>,</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>              <span class="at">Fuel_gt_50_S =</span> <span class="fu">sum</span>(DRYBIO_AC_COND[DECAYCD <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)   <span class="sc">&amp;</span> TRANSDIA <span class="sc">&gt;=</span> <span class="dv">50</span>])<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  coarse_fuels_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(coarse_fuels_table, coarsefuels)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"The stands in "</span>, states[db], <span class="st">" have been found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-4" class="level2">
<h2 class="anchored" data-anchor-id="part-4">Part 4</h2>
<ol start="4" type="1">
<li>New db</li>
</ol>
<ul>
<li>correct CNs to chr</li>
<li>add coarse fuel data from FM to TM</li>
<li>add fine fuel data from FM to TM</li>
<li>set column names</li>
<li>add fuel to the new stand table
<ul>
<li>I am not sure why FWD and stuff are being multiplied by 2</li>
</ul></li>
<li>Set CN to STAND_CN for FVS</li>
<li>Set X and X.1 to Null</li>
<li>Set a key to sort and filter</li>
<li>add fine fuels to new stand table</li>
<li>join the fine and coarse fuel tables</li>
<li>Remove PredCN and NA values</li>
<li>write new db.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fuel_stands_filtered)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered <span class="ot">&lt;-</span> <span class="fu">setkey</span>(fuel_stands_filtered, STAND_CN)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>stand_table <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stand_table, STAND_CN)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add fine fuels.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  stand_table, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  fuel_stands_filtered[, <span class="fu">c</span>(<span class="st">"STAND_CN"</span>,<span class="st">"Fuel_0_25_H"</span>,<span class="st">"Fuel_25_1_H"</span>,<span class="st">"Fuel_1_3_H"</span>,<span class="st">"Fuel_Litter"</span>,<span class="st">"Fuel_Duff"</span>)])</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stands_with_finefuels, STAND_CN)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coarse_fuels_table_stands)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">setkey</span>(coarse_fuels_table_stands, STAND_CN)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>stands_with_fuels <span class="ot">&lt;-</span> <span class="fu">left_join</span>(stands_with_finefuels, coarse_fuels_table_stands)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>stands_with_fuels<span class="sc">$</span>PredCN <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NA values when writing files (FVS does NOT like them)</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="do">### UPDATE YOUR OUTPUT FILE NAMES HERE </span><span class="al">###</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(tree_table, <span class="at">file =</span> <span class="st">"tree_table_R1_Carbon_2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(stands_with_fuels, <span class="at">file =</span> <span class="st">"stand_table_R1_Carbon2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Original stand data from Fuel Map.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>PredCN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(fuel_stands_filtered<span class="sc">$</span>PredCN)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>ObsCN <span class="ot">&lt;-</span> <span class="fu">as.character</span>(fuel_stands_filtered<span class="sc">$</span>ObsCN)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  fuel_stands_filtered[, <span class="fu">c</span>(<span class="st">"PredCN"</span>, <span class="st">"ObsCN"</span>)], </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  coarse_fuels_table,  <span class="at">by.x =</span> <span class="st">"PredCN"</span>, <span class="at">by.y =</span> <span class="st">"PLT_CN"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>fine_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  fuel_stands_filtered[,<span class="fu">c</span>(<span class="st">"PredCN"</span>, <span class="st">"ObsCN"</span>)], </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  fine_fuels_table,  <span class="at">by.y =</span> <span class="st">"PLT_CN"</span>, <span class="at">by.x =</span> <span class="st">"PredCN"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stand_table) <span class="ot">&lt;-</span> stand_header</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Add fuel variables to the stand data</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_0_25_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_SM_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_25_1_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_MD_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_1_3_H <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>FWD_LG_CARBON_COND<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_Litter <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>LITTER_CARBON<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>Fuel_Duff <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>fuel_stands_filtered<span class="sc">$</span>DUFF_CARBON<span class="sc">/</span><span class="dv">2000</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fuel_stands_filtered)[<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered<span class="sc">$</span>X <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>fuel_stands_filtered <span class="ot">&lt;-</span> <span class="fu">setkey</span>(fuel_stands_filtered, STAND_CN)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>stand_table <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stand_table, STAND_CN)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add fine fuels.</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  stand_table, </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  fuel_stands_filtered[, <span class="fu">c</span>(<span class="st">"STAND_CN"</span>,<span class="st">"Fuel_0_25_H"</span>,<span class="st">"Fuel_25_1_H"</span>,<span class="st">"Fuel_1_3_H"</span>,<span class="st">"Fuel_Litter"</span>,<span class="st">"Fuel_Duff"</span>)]</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>stands_with_finefuels <span class="ot">&lt;-</span> <span class="fu">setkey</span>(stands_with_finefuels, STAND_CN)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coarse_fuels_table_stands)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"STAND_CN"</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>coarse_fuels_table_stands <span class="ot">&lt;-</span> <span class="fu">setkey</span>(coarse_fuels_table_stands, STAND_CN)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>stands_with_fuels <span class="ot">&lt;-</span> <span class="fu">left_join</span>(stands_with_finefuels, coarse_fuels_table_stands)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>stands_with_fuels<span class="sc">$</span>PredCN <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NA values when writing files (FVS does NOT like them)</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="do">### UPDATE YOUR OUTPUT FILE NAMES HERE </span><span class="al">###</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(tree_table, <span class="at">file =</span> <span class="st">"tree_table_R1_Carbon_2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(stands_with_fuels, <span class="at">file =</span> <span class="st">"stand_table_R1_Carbon2014.csv"</span>, <span class="at">na =</span> <span class="st">""</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</div>
</div>
</div>
<section id="re-write" class="level1">
<h1>Re-Write</h1>
<section id="pseudo-code" class="level3">
<h3 class="anchored" data-anchor-id="pseudo-code">Pseudo code</h3>
<ol type="1">
<li><strong>setup</strong></li>
</ol>
<ul>
<li>Read in standlist from 1_Import_Clean.csv</li>
<li>Ensure there are no repeat plt_cns</li>
</ul>
<ol start="2" type="1">
<li><strong>Tree table</strong></li>
</ol>
<ul>
<li>Create header for tree table.</li>
<li>Ensure blank tree table to write to</li>
<li>Connect to the state db</li>
<li>Set tree to those columns needed for FVS from FIA TREE table</li>
<li>Pull the standlist from the TREE table</li>
<li>Change FIA.TREE.SPCD to Species, Set History to 1, and Change CR to CrRatio</li>
<li>Where AgentCD is not null set History to 8</li>
<li>Select the columns needed</li>
<li>Disconnect from the state db</li>
<li>Find forest type reference in a db, this is confusing, there is no connection</li>
<li>Set the tree table names</li>
<li>Find all plots with trees in the tree list.</li>
</ul>
<ol start="3" type="1">
<li><strong>Plots table</strong></li>
</ol>
<ul>
<li>Set the stand header</li>
<li>Ensure a blank canvas with NULL stand</li>
<li>Connect to db</li>
<li>Set tables</li>
<li>Select CN and invyr from plot</li>
<li>Find all standlist in plot table by CN
<ul>
<li>Set := INV_YEAR = 2014: Adds a new column INV_YEAR with all entries set to 2014.</li>
<li>CASE = (INVYR): Adds a new column CASE and sets its values to be the same as those in the existing column INVYR.</li>
<li>INVYR = NULL: Removes the INVYR column from the data.table.</li>
<li>BASAL_AREA_FACTOR = 0: Adds a new column BASAL_AREA_FACTOR with all entries set to 0.</li>
<li>INV_PLOT_SIZE = 1: Adds a new column INV_PLOT_SIZE with all entries set to 1.</li>
<li>BRK_DBH = 999: Adds a new column BRK_DBH with all entries set to 999.</li>
</ul></li>
<li>Make the stand table</li>
<li>Disconnect</li>
</ul>
<ol start="4" type="1">
<li><strong>Seedlings table</strong></li>
</ol>
<ul>
<li>Copy the header for tree table.</li>
<li>Ensure blank seed table to write to</li>
<li>Connect to the state db</li>
<li>Set seed to those columns needed for FVS from FIA SEEDLING table</li>
<li>Use the same standlist from the TREE table</li>
<li>Change FIA.SEEDLING.SPCD to Species, Set History to 1, and set CR &amp; CrRatio to NA</li>
<li>Select the columns needed</li>
<li>Disconnect from the state db</li>
<li>Set the seed table names</li>
<li>Find all plots with trees in the seed table.</li>
<li>Set the TREE id by adding a row number for each record in the seedlings table per stand. I copied FVS Ready and set all seedling IDs to 100100 + rownumber
<ul>
<li>Probably should have done this by standplot_cn</li>
</ul></li>
<li>Ensure the seedling and tree tables match.</li>
<li>Add the seedling records to the tree table.</li>
</ul>
<ol start="5" type="1">
<li><strong>New db</strong></li>
</ol>
<ul>
<li>Add Standplot_cn to the tree table.</li>
<li>Add Standplot_cn to the plot table by repeating the plot records 4 times for each plot, then joining the plots to the tree tableâ€™s Standplot_cn to ensure there are no empty of fake subplots introduced.</li>
<li>Make sure all tables have the same Plots and Subplots.</li>
<li>Set table names and types to match FVS.</li>
<li>Create the blank DB.</li>
<li>Set DB schema
<ul>
<li>Setting table names and setting schema may have been redundant. However, the way I did it last time was to use the schema. This time, that did not translate the column types to the DB &amp; it caused errors due to Species being numeric. I do not know why setting the schema did not work.<br>
</li>
</ul></li>
<li>Add the tables to the db, then copy them so the new schema and delete the interim tables.
<ul>
<li>This is also redundant. Again, last time, this was how I ensured the proper data types for FVS, but it didnâ€™t work the same this time.</li>
</ul></li>
</ul>
</section>
<section id="parts-1-3" class="level2">
<h2 class="anchored" data-anchor-id="parts-1-3">Parts 1-3</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 1 Setup</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>standlist <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./1_Import_Clean2.csv"</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">col_types =</span> <span class="st">"ccc"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>standlist <span class="ot">&lt;-</span> standlist <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">SUBP =</span> <span class="fu">str_sub</span>(STANDPLOT_CN, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(SUBP, <span class="at">.after =</span> PLT_CN)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> standlist <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">CN =</span> PLT_CN) <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.table</span>()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>target_stands <span class="ot">&lt;-</span> <span class="fu">setkey</span>(target_stands, CN)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>plt_cn <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>plt_cn <span class="ot">&lt;-</span> <span class="fu">str_c</span>(<span class="st">"'"</span>, target_stands<span class="sc">$</span>CN, <span class="st">"'"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>plt_cn <span class="ot">&lt;-</span> <span class="fu">str_flatten_comma</span>(plt_cn)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 2 Tree Table ------------------------------------------------------------------------------------------------</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>tree_header <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"STAND_CN"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"Tree_count"</span>, <span class="st">"SPCD"</span>, <span class="st">"DBH"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>, <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>, </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through every state database and extracts the tree data from FIA</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>tree_table <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># connect to the sqlite file</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>con <span class="ot">=</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"C:/RxFire/Data/_FIADB_WA.db"</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="do">#######</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Add statuscd to fix live or dead trees like: HISTORY = ifelse(STATUSCD != 1, 8, 1)  Live tree == 1, dead == 2, </span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># other = not there. </span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbGetQuery</span>(</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    con, <span class="fu">str_c</span>(<span class="st">'select PLT_CN, INVYR, STATUSCD, TPA_UNADJ, SPCD, DIA, HT, ACTUALHT, CR, SUBP, TREE, AGENTCD from TREE '</span>, </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>               <span class="st">'where PLT_CN in ('</span>, plt_cn, <span class="st">")"</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># n_distinct(tree$PLT_CN)</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 3426 PLT_CNs have trees in the TREE table</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">Species =</span> SPCD, </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">History =</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(AGENTCD), <span class="dv">8</span>, <span class="dv">1</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">CrRatio =</span> CR</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>INVYR)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>forest_type <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="st">'select * FROM REF_FOREST_TYPE'</span>))</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tree) <span class="ot">&lt;-</span> <span class="fu">toupper</span>(tree_header)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 3 Plot Table --------------------------------------------------------------------------------------------</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>stand_header <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"STAND_CN"</span>, <span class="st">"INV_YEAR"</span>, <span class="st">"CASE"</span>, <span class="st">"BASAL_AREA_FACTOR"</span>, <span class="st">"INV_PLOT_SIZE"</span>, <span class="st">"BRK_DBH"</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="co"># connect to the sqlite file</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span>  <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"C:/RxFire/Data/_FIADB_WA.db"</span>)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">dbGetQuery</span>(con, <span class="fu">str_c</span>(</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">'select CN, INVYR from PLOT where CN in ('</span>, </span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>  plt_cn, <span class="st">")"</span>)</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> <span class="fu">setkey</span>(plot_table, CN)</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> plot_table <span class="sc">|&gt;</span>  </span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">INV_YEAR =</span> <span class="dv">2014</span>, </span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">CASE =</span> (INVYR), </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">INVYR =</span> <span class="cn">NA</span>, </span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">BASAL_AREA_FACTOR =</span> <span class="dv">0</span>, </span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">INV_PLOT_SIZE =</span> <span class="dv">1</span>, </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">BRK_DBH =</span> <span class="dv">999</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>() <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">STAND_CN =</span> CN) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>INVYR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-4-1" class="level2">
<h2 class="anchored" data-anchor-id="part-4-1">Part 4</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 4 Seedling Table ----------------------------------------------------------------------------------------</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>tree_header <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"STAND_CN"</span>, <span class="st">"STATUSCD"</span>, <span class="st">"Tree_count"</span>, <span class="st">"SPCD"</span>, <span class="st">"DBH"</span>, <span class="st">"HT"</span>, <span class="st">"ACTUALHT"</span>, <span class="st">"CR"</span>, <span class="st">"SUBP"</span>, <span class="st">"TREE"</span>, <span class="st">"AGENTCD"</span>, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Species"</span>, <span class="st">"History"</span>, <span class="st">"CrRatio"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This loop iterates through every state database and extracts the tree data from FIA</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># connect to the sqlite file</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span>  <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">"C:/RxFire/Data/_FIADB_WA.db"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbGetQuery</span>(</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    con, <span class="fu">str_c</span>(<span class="st">'select PLT_CN, INVYR, SUBP, TPA_UNADJ, SPCD from SEEDLING '</span>, </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">'where PLT_CN in ('</span>, plt_cn, <span class="st">")"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># These are not in the seedlings table: STATUSCD, DIA, HT, ACTUALHT, CR, SUBP, TREE, AGENTCD</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># n_distinct(seed$PLT_CN)</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 2818 PLT_CNs have trees in the SEEDLINGS table</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> seed <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">STAND_CN   =</span>  PLT_CN,      </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">INVYR      =</span>  INVYR,         </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">STATUSCD   =</span>  <span class="dv">1</span>,         </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tree_count =</span>  TPA_UNADJ,         </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">SPCD       =</span>  SPCD,         </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">DBH        =</span>  <span class="fl">0.1</span>,         </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">HT         =</span>  <span class="cn">NA</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">ACTUALHT   =</span>  <span class="cn">NA</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">CR         =</span>  <span class="cn">NA</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">SUBP       =</span>  SUBP,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">TREE       =</span>  <span class="cn">NA</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">AGENTCD    =</span>  <span class="cn">NA</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">Species    =</span> SPCD,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">History    =</span> <span class="dv">1</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">CrRatio    =</span> <span class="cn">NA</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">select</span>(</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  STAND_CN, INVYR, STATUSCD, Tree_count, SPCD, DBH, HT, ACTUALHT, </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  CR, SUBP, TREE, AGENTCD, Species,History, CrRatio) <span class="sc">|&gt;</span> </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>INVYR)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(seed) <span class="ot">&lt;-</span> seed <span class="sc">|&gt;</span> <span class="fu">names</span>() <span class="sc">|&gt;</span> <span class="fu">toupper</span>()</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixing the Tree column. </span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> seed <span class="sc">|&gt;</span> <span class="fu">group_by</span>(STAND_CN) <span class="sc">|&gt;</span> </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nrow =</span> <span class="fu">row_number</span>(), </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">TREE =</span> (<span class="dv">100100</span> <span class="sc">+</span> Nrow)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>Nrow)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="do">## Checking that it worked as planned. </span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="co"># seed |&gt; group_by(STAND_CN) |&gt; </span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(n = n()) |&gt; </span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co">#   arrange(desc(n))</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="co"># seed |&gt; filter(STAND_CN == "40220797010497")</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="co"># seed |&gt; filter(STAND_CN == "22398336010497")</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co"># seed |&gt; filter(STAND_CN == "645308766126144")</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>fvs_tree <span class="ot">&lt;-</span> <span class="fu">add_row</span>(tree, seed)</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co"># fvs_tree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-5" class="level2">
<h2 class="anchored" data-anchor-id="part-5">Part 5</h2>
<p><em>Adding Standplot_cn to the tables</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>splt_cn <span class="ot">&lt;-</span> fvs_tree <span class="sc">|&gt;</span> <span class="fu">select</span>(STAND_CN, SUBP) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">STANDPLOT_CN =</span> <span class="fu">str_c</span>(STAND_CN, <span class="st">"_"</span>, SUBP)) <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>fvs_tree <span class="ot">&lt;-</span> fvs_tree <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">STANDPLOT_CN =</span> <span class="fu">str_c</span>(STAND_CN, <span class="st">"_"</span>, SUBP)) <span class="sc">|&gt;</span> <span class="fu">relocate</span>(STANDPLOT_CN, <span class="at">.after =</span> STAND_CN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> plot_table <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">uncount</span>(<span class="at">weights =</span> <span class="dv">4</span>, <span class="at">.id =</span> <span class="st">"SUBP"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">STANDPLOT_CN =</span> <span class="fu">str_c</span>(STAND_CN, <span class="st">"_"</span>, SUBP)) <span class="sc">|&gt;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(STANDPLOT_CN, <span class="at">.after =</span> STAND_CN) <span class="sc">|&gt;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>SUBP)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> <span class="fu">left_join</span>(splt_cn, plot_table, <span class="fu">join_by</span>(STANDPLOT_CN, STAND_CN))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(fvs_tree<span class="sc">$</span>STANDPLOT_CN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15369</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(fvs_tree<span class="sc">$</span>STAND_CN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3945</code></pre>
</div>
</div>
<p>There are fewer plots here than I started with, but I am pretty sure they were plots with dead trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plot_table <span class="sc">|&gt;</span> <span class="fu">filter</span>(STAND_CN <span class="sc">==</span> <span class="st">"12981943010497"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 5%">
<col style="width: 18%">
<col style="width: 9%">
<col style="width: 5%">
<col style="width: 19%">
<col style="width: 15%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">STAND_CN</th>
<th style="text-align: right;">SUBP</th>
<th style="text-align: left;">STANDPLOT_CN</th>
<th style="text-align: right;">INV_YEAR</th>
<th style="text-align: right;">CASE</th>
<th style="text-align: right;">BASAL_AREA_FACTOR</th>
<th style="text-align: right;">INV_PLOT_SIZE</th>
<th style="text-align: right;">BRK_DBH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">12981943010497</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">12981943010497_1</td>
<td style="text-align: right;">2014</td>
<td style="text-align: right;">2005</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">999</td>
</tr>
<tr class="even">
<td style="text-align: left;">12981943010497</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">12981943010497_2</td>
<td style="text-align: right;">2014</td>
<td style="text-align: right;">2005</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">999</td>
</tr>
<tr class="odd">
<td style="text-align: left;">12981943010497</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">12981943010497_3</td>
<td style="text-align: right;">2014</td>
<td style="text-align: right;">2005</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">999</td>
</tr>
<tr class="even">
<td style="text-align: left;">12981943010497</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">12981943010497_4</td>
<td style="text-align: right;">2014</td>
<td style="text-align: right;">2005</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">999</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>I am not sure why I am getting a different number of trees here, 3434. At the end of section 2 of 1_Import and Clean, 3,531 of 3,552 plots have trees. There are a few less plots here, and I am surprised.</p>
<p>Rachelâ€™s code here is using CSVs, that might be easier than running with an Sqlite db.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plot_table <span class="ot">&lt;-</span> plot_table <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">OYEAR =</span> CASE) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>SUBP)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fvs_tree <span class="ot">&lt;-</span> fvs_tree <span class="sc">|&gt;</span> <span class="fu">select</span>(STAND_CN, STANDPLOT_CN, TREE, TREE_COUNT, HISTORY, SPECIES, DBH, HT, CR, CRRATIO)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>fvs_tree <span class="ot">&lt;-</span> fvs_tree <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">STAND_CN      =</span>  <span class="fu">as.character</span>(STAND_CN),  </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">STANDPLOT_CN  =</span>  <span class="fu">as.character</span>(STANDPLOT_CN),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">TREE          =</span>  <span class="fu">as.character</span>(TREE), </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">TREE_COUNT    =</span>  <span class="fu">as.numeric</span>(TREE_COUNT), </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">HISTORY       =</span>  <span class="fu">as.numeric</span>(HISTORY), </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">SPECIES       =</span>  <span class="fu">as.character</span>(SPECIES), </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">DBH           =</span>  <span class="fu">as.numeric</span>(DBH), </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">HT            =</span>  <span class="fu">as.numeric</span>(HT), </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">CR            =</span>  <span class="fu">as.numeric</span>(CR), </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">CRRATIO       =</span>  <span class="fu">as.numeric</span>(CRRATIO)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># str(fvs_tree)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Part 5 Create DB ---------------------------------------------------------------------------------</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">getwd</span>()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Just to make it easier to integrate this into the other scripts I am renaming the tables FVS_...</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname =</span> <span class="st">"./homemade_fvs_db_17sept24.db"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con, <span class="at">name =</span> <span class="st">"FVS_PLOTINIT"</span>, <span class="at">value =</span> plot_table, <span class="at">overwrite =</span> T)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con, <span class="at">name =</span> <span class="st">"FVS_TREEINIT"</span>, <span class="at">value =</span> fvs_tree, <span class="at">overwrite =</span> T)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the schema</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="fu">str_c</span>(<span class="st">"CREATE TABLE FVS_PLOTINIT_PLOT ("</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"STAND_CN TEXT, "</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"STANDPLOT_CN TEXT, "</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"INV_YEAR INTEGER, "</span>,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"OYEAR INTEGER, "</span>,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"BASAL_AREA_FACTOR REAL, "</span>,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"INV_PLOT_SIZE REAL, "</span>,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"BRK_DBH REAL)"</span>))</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>plot_table <span class="sc">|&gt;</span> <span class="fu">names</span>()</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="fu">str_c</span>(<span class="st">"INSERT INTO FVS_PLOTINIT_PLOT SELECT * FROM FVS_PLOTINIT"</span>))</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"DROP TABLE FVS_PLOTINIT"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 9.2 TREE SCHEMA ---------------------------------------------------------</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="fu">str_c</span>(<span class="st">"CREATE TABLE FVS_TREEINIT_PLOT ( "</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"STAND_CN TEXT, "</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"STANDPLOT_CN TEXT, "</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"TREE TEXT, "</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"TREE_COUNT REAL, "</span>,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"HISTORY   REAL, "</span>,</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"SPECIES   TEXT, "</span>,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"DBH REAL, "</span>,</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"HT REAL, "</span>,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"CR    REAL, "</span>,</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"CRRATIO   REAL)"</span>))</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="fu">str_c</span>(<span class="st">"INSERT INTO FVS_TREEINIT_PLOT SELECT * FROM FVS_TREEINIT"</span>))</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"DROP TABLE FVS_TREEINIT"</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(<span class="at">conn =</span> con)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NA values when writing files (FVS does NOT like them)</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="do">### UPDATE YOUR OUTPUT FILE NAMES HERE </span><span class="al">###</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(tree_table, file = "tree_table_R1_Carbon_2014.csv", na = "", row.names = FALSE)</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(stands_with_fuels, file = "stand_table_R1_Carbon2014.csv", na = "", row.names = FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># splt_cn &lt;- splt_cn |&gt; select(STAND_CN, STANDPLOT_CN)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># write_csv(splt_cn, "./1.5_dbCreation_standlist.csv")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="difference-in-nrows" class="level1">
<h1>Difference in nrows</h1>
<p><strong>Where is the difference</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># end1.5 &lt;- read_csv("./1.5_dbCreation_standlist.csv")</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># end1.0 &lt;- read_csv("./1_Import_Clean2.csv", </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                       col_types = "ccc")</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># t &lt;- anti_join(end1.0, end1.5, join_by(STANDPLOT_CN))</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># n_distinct(t$STANDPLOT_CN)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># t %&gt;% head()</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># cns &lt;- db_list(t, PLT_CN)</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># con &lt;- dbConnect(RSQLite::SQLite(), "c:/RxFire/Data/_FIADB_WA.db")</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># trees &lt;- dbGetQuery(con, str_c("select * from TREE where PLT_CN in (", cns, ")"))</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># seeds &lt;- dbGetQuery(con, str_c("select * from SEEDLING where PLT_CN in (", cns, ")"))</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co"># trees &lt;- clean_na_cols(trees)</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># seeds &lt;- clean_na_cols(seeds)</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># sum(is.na(trees$AGENTCD))</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co"># nrow(trees)</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># unique(trees$STATUSCD)</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># trees %&gt;% filter(!is.na(AGENTCD))</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co"># t &lt;- trees %&gt;% filter(STATUSCD != 1 &amp; !is.na(AGENTCD))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I went back up and found where the reduction in subplots came in, they are subplots that were created in the first script, but didnâ€™t have matches in the tree table. The Plt CNs match but the standplot cns do not.</p>
</section>
<section id="difference-in-.out-file" class="level1">
<h1>Difference in .out file</h1>
<p>This is all much the same as the FVS Ready translation. However, there are fewer fields entered via this method. I would need to crossreference the .out files to see which fields FVS is reading from FVS_Ready if I wanted to know what the actual difference is.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[[10,5], [40,20], [26,13], [2,1]]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 66.7%;justify-content: flex-start;">
<pre><code>STANDSQL   STANDSQL COMMAND FOR INPUT DATA BASE: 
                          C:/RxFire/Data/FIADB_NSA.db
           SELECT * FROM FVS_PLOTINIT_PLOT
           WHERE  STANDPLOT_CN  = '%Stand_CN%'

           STAND-LEVEL DATA BASE READ:
           INV_YEAR:               2014
           REGION:                    1
           FOREST:                   13
            COMPOSITE LOC:          113
           PLANT ASSOCIATION CODE USED IN THIS PROJECTION IS CPS241  
 LEAVING HABTYP KODTYP,ITYPE,ICL5,KARD2 PCOM = 114 114 114 CPS241 CPS241  
           HABITAT/PV_CODE:         670
           PV REFERENCE CODE:       110
           AGE:                      89
           ASPECT:                202.0
           SLOPE:                 28.00
           ELEVFT:               5480.0 CONVERTED TO:   54.8
           BASAL_AREA_FACTOR:     -24.0
           INV_PLOT_SIZE:          300.
           BRK_DBH:                 5.0
           NUM_PLOTS:                 1
           SAM_WT:          5614.369141
           DG_TRANS:                  1
           DG_MEASURE:               10
           HTG_TRANS:                 1
           HTG_MEASURE:              10
           MORT_MEASURE:             10
           PHYSIO_REGION:            22
           STATE:                    16
           COUNTY:                   17
           FUEL_12_20_H:          3.181
           FUEL_LITTER:           2.896
           FUEL_DUFF:             7.991
           END OF DATA BASE READ.



********   FVS03 WARNING:  FOREST CODE INDICATES THE 
GEOGRAPHIC LOCATION IS OUTSIDE THE RANGE OF THE MODEL.  
DEFAULT CODE IS USED.

********   FOREST CODE USED IN THIS PROJECTION IS 606
           LOCATION:                113

********   FVS03 WARNING:  FOREST CODE INDICATES THE 
GEOGRAPHIC LOCATION IS OUTSIDE THE RANGE OF THE MODEL.  
DEFAULT CODE IS USED.

********   FOREST CODE USED IN THIS PROJECTION IS 606
           LONGITUDE:         -116.1252
           LATITUDE:            48.3026

********   FVS33 WARNING:  PV CODE WAS NOT RECOGNIZED; 
HABITAT/PLANT ASSOCIATION/ECOREGION SET TO DEFAULT CODE.

********   FVS32 WARNING:  PV REFERENCE CODE WAS NOT RECOGNIZED; 
HABITAT/PLANT ASSOCIATION/ECOREGION SET TO DEFAULT CODE.      </code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<pre><code>STANDSQL   STANDSQL COMMAND FOR INPUT DATA BASE: 
      C:/RxFire/Regen/Regen2_08Aug24/homemade_fvs_db2.db
           SELECT * FROM FVS_PLOTINIT_PLOT
           WHERE  STANDPLOT_CN  = '%STAND_CN%'

           STAND-LEVEL DATA BASE READ:
           INV_YEAR:               2014
           BASAL_AREA_FACTOR:       0.0
           INV_PLOT_SIZE:            1.
           BRK_DBH:               999.0
           END OF DATA BASE READ.
           
         
********   FVS03 WARNING:  FOREST CODE INDICATES THE 
GEOGRAPHIC LOCATION IS OUTSIDE THE RANGE OF THE MODEL.  
DEFAULT CODE IS USED.

********   FOREST CODE USED IN THIS PROJECTION IS 606
</code></pre>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 66.7%;justify-content: flex-start;">
<pre><code>DSNIN      INPUT DATA BASE IS C:/RxFire/Data/FIADB_NSA.db

TREESQL    TREESQL COMMAND FOR INPUT DATA BASE: 
                          C:/RxFire/Data/FIADB_NSA.db
           SELECT * FROM FVS_TREEINIT_PLOT
           WHERE  STANDPLOT_CN  = '%Stand_CN%'
           STAND_CN           WAS IGNORED
           STAND_ID           WAS IGNORED
           PLOT_CN            WAS IGNORED
           STANDPLOT_CN       WAS IGNORED
           STANDPLOT_ID       WAS IGNORED
           PLOT_ID            WAS USED
           TREE_CN            WAS IGNORED
           TREE_ID            WAS USED
           TAG_ID             WAS IGNORED
           AZIMUTH            WAS IGNORED
           DISTANCE           WAS IGNORED
           SITE_TREE_FLAG     WAS IGNORED
           TREE_COUNT         WAS USED
           MORT_AGENT         WAS IGNORED
           WDLND_STEMS        WAS IGNORED
           HISTORY            WAS USED
           SPECIES            WAS USED
           DIAMETER           WAS USED
           DIAMETER_HTCD      WAS IGNORED
           DG                 WAS USED
           HT                 WAS USED
           HTG                WAS USED
           HTTOPK             WAS USED
           HTBOLE             WAS IGNORED
           TPBOLE             WAS IGNORED
           HTSAW              WAS IGNORED
           TPSAW              WAS IGNORED
           HT_TO_CROWN_BASE   WAS IGNORED
           CRRATIO            WAS USED
           UNCRRATIO          WAS IGNORED
           CRCLASS            WAS IGNORED
           DAMAGE1            WAS USED
           SEVERITY1          WAS USED
           DAMAGE2            WAS USED
           SEVERITY2          WAS USED
           DAMAGE3            WAS USED
           SEVERITY3          WAS USED
           DEFECT_CUBIC       WAS IGNORED
           DEFECT_BOARD       WAS IGNORED
           TREEVALUE          WAS USED
           PRESCRIPTION       WAS USED
           AGE                WAS USED
           BH_YEARS           WAS IGNORED
           SLOPE              WAS USED
           ASPECT             WAS USED
           PV_CODE            WAS USED
           PV_REF_CODE        WAS IGNORED
           TOPOCODE           WAS USED
           SITEPREP           WAS USED
           CREATED_BY         WAS IGNORED
           CREATED_DATE       WAS IGNORED
           CREATED_IN_INSTANC WAS IGNORED
           MODIFIED_BY        WAS IGNORED
           MODIFIED_DATE      WAS IGNORED
           MODIFIED_IN_INSTAN WAS IGNORED
           VERSION            WAS IGNORED
           NUMBER ROWS PROCESSED:   18

END        END OF DATA BASE OPTIONS.



</code></pre>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<pre><code>DSNIN      INPUT DATA BASE IS 
      C:/RxFire/Regen/Regen2_08Aug24/homemade_fvs_db2.db

TREESQL    TREESQL COMMAND FOR INPUT DATA BASE: 
      C:/RxFire/Regen/Regen2_08Aug24/homemade_fvs_db2.db
           SELECT * FROM FVS_TREEINIT_PLOT
           WHERE  STANDPLOT_CN  = '%STAND_CN%'
           STAND_CN           WAS IGNORED
           STANDPLOT_CN       WAS IGNORED
           TREE               WAS IGNORED
           TREE_COUNT         WAS USED
           HISTORY            WAS USED
           SPECIES            WAS USED
           DBH                WAS USED
           HT                 WAS USED
           CR                 WAS IGNORED
           CRRATIO            WAS USED
           NUMBER ROWS PROCESSED:   17
           
  </code></pre>
</div>
</div>
</div>
<p>Columns read in FVS_ready TREE, but not in mine:</p>
<p>These can be added easily:</p>
<ul>
<li>Tree_ID is OURS.TREE</li>
<li>Plot_ID is OURS.SUBP</li>
<li>AGE is TREE.BHage or TREE.TOTAGE</li>
<li>SLOPE is SUBPLOT.SLOPE</li>
<li>ASPECT is SUBPLOT.ASPECT</li>
<li>HTTPOK is TREE.ACTUALHT</li>
</ul>
<p>These could be added:</p>
<ul>
<li>DG</li>
<li>HTG</li>
<li>DAMAGE AND SEVERITY</li>
</ul>
<p>These are not important:</p>
<ul>
<li>TREEVALUE <em>NULL in FVS Ready</em></li>
<li>PRESCRIPTION <em>NULL in FVS Ready</em></li>
<li>PV_CODE <em>NULL in FVS Ready</em></li>
<li>TOPOCODE <em>NULL in FVS Ready</em></li>
<li>SITEPREP <em>NULL in FVS Ready</em></li>
</ul>
<p>Columns in FVS Ready Plot that are not in mine:</p>
<p>These might make a difference:</p>
<ul>
<li>HABITAT/PV_CODE:<br>
</li>
<li>AGE:<br>
</li>
<li>ASPECT:<br>
</li>
<li>SLOPE:<br>
</li>
<li>ELEVFT:<br>
</li>
<li>NUM_PLOTS:<br>
</li>
<li>DG_TRANS:<br>
</li>
<li>DG_MEASURE:<br>
</li>
<li>HTG_TRANS:<br>
</li>
<li>HTG_MEASURE:<br>
</li>
<li>MORT_MEASURE:<br>
</li>
<li>PHYSIO_REGION:</li>
</ul>
<p>These will not make a difference:</p>
<ul>
<li>PV REFERENCE CODE:</li>
<li>SAM_WT:<br>
</li>
<li>STATE:<br>
</li>
<li>COUNTY:</li>
</ul>
<p>These are not important for Regen:</p>
<ul>
<li>FUEL_12_20_H:<br>
</li>
<li>FUEL_LITTER:<br>
</li>
<li>FUEL_DUFF:</li>
</ul>
<p>These should be written from our map to tell FVS which area we are growing them in:</p>
<ul>
<li>REGION:<br>
</li>
<li>FOREST:<br>
</li>
<li>COMPOSITE LOC:</li>
</ul>
</section>
<section id="end" class="level1">
<h1>End</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/KingBlkMouth\.github\.io\/Regen_Regression\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>